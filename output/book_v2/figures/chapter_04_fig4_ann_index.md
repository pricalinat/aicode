# 图4.4：近似最近邻(ANN)检索技术

```
问题背景:
• 商品数量: 10亿+
• 向量维度: 768 (BERT)
• 计算复杂度: O(N×D)
• 实时性要求: <100ms

解决方案: ANN索引

方法一: IVF (Inverted File)
┌─────────────────────────────────────────────────────────────────────┐
│                                                                      │
│  步骤1: 聚类                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  使用K-Means将商品向量聚类到K个簇                             │   │
│  │  簇中心: c_1, c_2, ..., c_K                                 │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              ↓                                        │
│  步骤2: 倒排索引                                                   │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  簇1: [商品1, 商品5, 商品10, ...]                          │   │
│  │  簇2: [商品2, 商品7, 商品15, ...]                          │   │
│  │  ...                                                         │   │
│  │  簇K: [商品3, 商品8, 商品20, ...]                          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              ↓                                        │
│  步骤3: 检索                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  1. 找到查询向量最近的N个簇中心                              │   │
│  │  2. 只搜索这N个簇中的商品                                    │   │
│  │  3. 返回距离最近的Top-K商品                                 │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘

方法二: HNSW (Hierarchical Navigable Small World)
┌─────────────────────────────────────────────────────────────────────┐
│                                                                      │
│  构建多层图结构:                                                    │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  Layer 3:  ●───────●───────●  (长距离跳跃)                 │   │
│  │           ↙         ↘                                         │   │
│  │  Layer 2: ●──●──●──●──●──●──●                              │   │
│  │           ↙   ↘ ↙   ↘ ↙                                   │   │
│  │  Layer 1: ●●●●●●●●●●●●●●●●  (短距离连接)                  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  检索过程:                                                         │
│  1. 从高层入口开始                                                 │
│  2. 贪心搜索到当前层最近的邻居                                      │
│  3. 跳入下一层                                                     │
│  4. 重复直到最底层                                                 │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```
